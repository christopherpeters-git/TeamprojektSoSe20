<!DOCTYPE html>
<html lang="en">
<head>
	<title>three.js webgl - drag controls</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<link type="text/css" rel="stylesheet" href="main.css">
	<style>
		body {
			background-color: #f0f0f0;
			color: #444;
		}
		a {
			color: #08f;
		}
	</style>
</head>
<body>

<div id="info">
	<a href="https://threejs.org" target="_blank" rel="noopener">three.js</a> webgl - drag controls<br />
	Use "Shift+Click" to add/remove objects to/from a group.<br />
	Grouped objects can be transformed as a union.
</div>

<script type="module">

	import * as THREE from '../build/three.module.js';

	import { DragControls } from './jsm/controls/DragControls.js';

	var container;
	var camera, scene, renderer;
	var controls, group;
	var objects = [];
	var enableSelection = false;

	var mouse = new THREE.Vector2(), raycaster = new THREE.Raycaster();

	init();

	function init() {

		container = document.createElement( 'div' );
		document.body.appendChild( container );

		camera = new THREE.PerspectiveCamera( 70, window.innerWidth / window.innerHeight, 1, 5000 );
		camera.position.z = 1000;

		scene = new THREE.Scene();
		scene.background = new THREE.Color( 0xf0f0f0 );

		scene.add( new THREE.AmbientLight( 0x505050 ) );

		var light = new THREE.SpotLight( 0xffffff, 1.5 );
		light.position.set( 0, 500, 2000 );
		light.angle = Math.PI / 9;

		light.castShadow = true;
		light.shadow.camera.near = 1000;
		light.shadow.camera.far = 4000;
		light.shadow.mapSize.width = 1024;
		light.shadow.mapSize.height = 1024;

		scene.add( light );

		group = new THREE.Group();
		scene.add( group );
		group.name = "DragQueen";
		var geometry = new THREE.BoxBufferGeometry( 40, 40, 40 );

		for ( var i = 0; i < 10; i ++ ) {

			var object = new THREE.Mesh( geometry, new THREE.MeshLambertMaterial( { color: Math.random() * 0xffffff } ) );

			object.position.x = Math.random() * 1000 - 500;
			object.position.y = Math.random() * 600 - 300;
			object.position.z = Math.random() * 800 - 400;

			object.rotation.x = Math.random() * 2 * Math.PI;
			object.rotation.y = Math.random() * 2 * Math.PI;
			object.rotation.z = Math.random() * 2 * Math.PI;

			object.scale.x = Math.random() * 2 + 1;
			object.scale.y = Math.random() * 2 + 1;
			object.scale.z = Math.random() * 2 + 1;

			object.castShadow = true;
			object.receiveShadow = true;
			object.name = "Cube " + i;
			//scene.add( object );
			if(i%2 == 0) {

				var group1 = new THREE.Group();
				scene.add( group1 );

			}

			group1.add(object);
			if(group1.children.length == 2) {
				var colorR = Math.random() * 0xffffff;

				group1.children[0].material.color.set(colorR);
				group1.children[1].material.color.set(colorR);
				//objects.push(group1);
				objects.push(group1.children[0]);
				objects.push(group1.children[1]);
			}

			//objects.push( object );

		}
		console.log(objects);
		renderer = new THREE.WebGLRenderer( { antialias: true } );
		renderer.setPixelRatio( window.devicePixelRatio );
		renderer.setSize( window.innerWidth, window.innerHeight );

		renderer.shadowMap.enabled = true;
		renderer.shadowMap.type = THREE.PCFShadowMap;

		container.appendChild( renderer.domElement );

		controls = new DragControls( [ ... objects ], camera, renderer.domElement );
		controls.addEventListener( 'drag', render );

		//

		window.addEventListener( 'resize', onWindowResize, false );

		document.addEventListener( 'click', onClick, false );
		window.addEventListener( 'keydown', onKeyDown, false );
		window.addEventListener( 'keyup', onKeyUp, false );
		//console.log(scene);

		render();

	}

	function onWindowResize() {

		camera.aspect = window.innerWidth / window.innerHeight;
		camera.updateProjectionMatrix();

		renderer.setSize( window.innerWidth, window.innerHeight );

		render();

	}

	function onKeyDown( event ) {

		enableSelection = ( event.keyCode === 16 ) ? true : false;

	}

	function onKeyUp() {

		enableSelection = false;

	}

	function onClick( event ) {

		event.preventDefault();

		if ( enableSelection === true ) {
			console.log(scene);
			console.log(objects);
			var draggableObjects = controls.getObjects();
			draggableObjects.length = 0;

			mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1;
			mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1;

			raycaster.setFromCamera( mouse, camera );

			var intersections = raycaster.intersectObjects( objects, true );
			console.log(intersections.length);
			if ( intersections.length > 0 ) {

				var object = intersections[ 0 ].object;
				//console.log(object.parent);
				//console.log(group.children);
				//console.log(object);
				if ( group.children.includes( object ) === true ) {
					console.log("Gruppe wird geleert");
					var lengthGroup = group.children.length;
					for(var y = 0; y<scene.children.length;y++) {
						if(scene.children[y] instanceof THREE.Group && scene.children[y] !== group) {
							if(scene.children[y].children.length === 0) {
								for(var x = 0;x<lengthGroup;x++) {
									scene.children[y].attach(group.children[0]);
								}
							}
						}
					}
					//object.material.emissive.set( 0x000000 );
					//scene.attach( object );

				} else {
					var lengthGroup = group.children.length;
					for(var y = 0; y<scene.children.length;y++) {
						if(scene.children[y] instanceof THREE.Group && scene.children[y] !== group) {
							if(scene.children[y].children.length === 0) {
								for(var x = 0;x<lengthGroup;x++) {
									scene.children[y].attach(group.children[0]);
								}
							}
						}
					}

					//object.material.emissive.set( 0xaaaaaa );
					var lengthChilds = object.parent.children.length;
					var currentGroup = object.parent;
					for(var i = 0; i<lengthChilds;i++) {
						console.log(currentGroup.children[0].name);
						group.attach(currentGroup.children[0]);
					}
					//console.log(group);
					//console.log(scene);
					//console.log(objects);
					//group.attach( object );

				}

				controls.transformGroup = true;
				draggableObjects.push( group );

			}

			if ( group.children.length === 0 ) {
				console.log("gruppen nicht mehr bewegbar");
				controls.transformGroup = false;
				draggableObjects.push( ...objects );

			}

		}

		render();

	}

	function render() {

		renderer.render( scene, camera );

	}

</script>

</body>
</html>
